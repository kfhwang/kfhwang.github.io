/* @authors K.F.Hwang kfhwang@nutc.edu.tw & 王鴻逸 @karta1172128
 * @animator: 邱傳恩
 * @version v1.0.0 ar_ver1.js
 * @link http://ilab.nutc.edu.tw
 * Dept. Multimedia, National Taichung University of Science and Technology
 */
function Init(){dialogOption={show:"fade",hide:"fade",dialogClass:"no-close",width:"70%",buttons:[{text:"知道了",click:function(){$(this).dialog("close")}}]},0==/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&($("#dialog>p").html("為了獲得更好的使用經驗，您目前的設備不適合使用本系統!"),$("#dialog").dialog(dialogOption));const e=document.getElementById("camera");window.can={hevc:e.canPlayType('video/mp4; codecs="hvc1"'),webm:e.canPlayType("video/webm")},""==can.hevc&&""==can.webm&&($("#dialog>p").html("為了獲得更好的使用經驗，您目前的設備不適合使用本系統!"),$("#dialog").dialog(dialogOption)),window.addEventListener("resize",doResize),orien="portrait",orien=window.matchMedia("(orientation: portrait)").matches||window.matchMedia("(orientation: 0)").matches?"portrait":"landscape",videoCap=document.getElementById("camera"),videoCap.addEventListener("play",drawbox),captureSize=512,captureCanvas=document.createElement("canvas"),context=captureCanvas.getContext("2d"),captureCanvas.width=captureSize,captureCanvas.height=captureSize;navigator.mediaDevices.getUserMedia({video:{width:{ideal:1920},height:{ideal:1080},facingMode:"environment"},audio:!1}).then(function(e){videoCap.srcObject=e,videoCap.play()}).catch(function(e){$("#dialog>p").html("設備發生問題: 無法取得相機!"),$("#dialog").dialog(dialogOption)})}function doResize(){$("#canvasBox").remove(),drawbox()}function drawbox(){var e=$("#camera").width(),t=$("#camera").height();0==$("#cbox  > canvas").length&&((a=document.createElement("canvas")).width=e,a.height=t,a.style.zIndex=20,a.setAttribute("id","canvasBox"),$("#cbox").append(a));var a=document.getElementById("canvasBox");uiContext=a.getContext("2d"),uiContext.canvas.width=e,uiContext.canvas.height=t,uiContext.strokeStyle="rgba(200, 15, 30,.9)",uiContext.lineWidth=15,uiContext.globalAlpha=.8,boxsize=.65*e,t<e&&(boxsize=.65*t,uiContext.lineWidth=10),cap_L=(e-boxsize)/2,cap_T=(t-boxsize)/2,roundRect(uiContext,cap_L,cap_T,boxsize,boxsize,50,!1);var i=new Image;i.onload=function(){t<e?uiContext.drawImage(i,0,0,i.width,i.height,100,10,150,116):uiContext.drawImage(i,0,0,i.width,i.height,50,20,300,233)},i.src="images/logo.png",window.recogPercent=0,(correctBar=null)==correctBar&&(correctBar=new RadialBar(uiContext,{x:cap_L+boxsize/2,y:cap_T+boxsize/2,angle:360,title:"",radius:boxsize/6,lineWidth:40,lineFill:"rgba(198, 245, 200, 1)",progress:0,backLineFill:"rgba(250, 160, 60,1)",bgFill:"rgba(248, 255, 142, 0.9)",isShowInfoText:!0,infoStyle:"40px Microsoft JhengHei",infoColor:"rgba(166, 7, 28,1)"}))}function loopBar(){uiContext.clearRect(cap_L+18,cap_T+18,boxsize-36,boxsize-36),correctBar.add(2),correctBar.update(),correctBar.progress<recogPercent&&requestAnimationFrame(loopBar)}function roundRect(e,t,a,i,o,r,n,c){if(void 0===c&&(c=!0),void 0===r&&(r=5),"number"==typeof r)r={tl:r,tr:r,br:r,bl:r};else{var d,s={tl:0,tr:0,br:0,bl:0};for(d in s)r[d]=r[d]||s[d]}e.beginPath(),e.moveTo(t+r.tl,a),e.moveTo(t+i-r.tr,a),e.quadraticCurveTo(t+i,a,t+i,a+r.tr),e.moveTo(t+i,a+o-r.br),e.quadraticCurveTo(t+i,a+o,t+i-r.br,a+o),e.moveTo(t+r.bl,a+o),e.quadraticCurveTo(t,a+o,t,a+o-r.bl),e.moveTo(t,a+r.tl),e.quadraticCurveTo(t,a,t+r.tl,a),n&&e.fill(),c&&e.stroke()}function VideoClear(){$("#vidplayer").fadeOut(),timer=0,uiContext.beginPath(),uiContext.closePath(),uiContext.clearRect(cap_L+18,cap_T+18,boxsize-36,boxsize-36),$("#AndroidVid").attr("src",""),$("#IOSVid").attr("src","")}VideoSelet=function(e){e.stopPropagation(),window.removeEventListener("endProgress",VideoSelet),uiContext.beginPath(),uiContext.closePath(),uiContext.clearRect(cap_L+18,cap_T+18,boxsize-36,boxsize-36),recogPercent=0,correctBar.title="",correctBar.set(0),$("#canvasBox").fadeOut(),can.hevc?$("#IOSVid").attr("src","videos/"+videos[matchedIndex]+".mov"):can.webm&&$("#AndroidVid").attr("src","videos/"+videos[matchedIndex]+".webm"),(can.webm||can.hevc)&&($("#vidplayer")[0].load(),$("#vidplayer").fadeIn())};var matchedIndex,canDetection=!0,timer=0,notimer=!1,videos=["Birthday","Story","Volleyball","Exercise","Victory","SchoolCelebration","Announcement","Speech","Translation","ListenTo"],Titles=["生日","故事","坐地排球","運動","勝利","校慶","公告","演講","手語翻譯","聽打"];window.onload=function(){Init(),window.descriptorLength=128,window.blurRadius=3,window.matchLength=50,window.Threshold=6e5,window.fps=60,$("#vidplayer").on("ended",function(){canDetection||(canDetection=!0,$("#canvasBox").fadeIn(),VideoClear())}),targetGray={},targetCanvas=document.createElement("canvas"),targetCanvas.width=targetCanvas.height=captureSize,targetCtx=targetCanvas.getContext("2d");for(var e=0;e<videos.length;e++){targetCtx.drawImage(Target[e],0,0,captureSize,captureSize);var t=targetCtx.getImageData(0,0,captureSize,captureSize),t=tracking.Image.grayscale(tracking.Image.blur(t.data,captureSize,captureSize,blurRadius),captureSize,captureSize);targetGray[videos[e]]={},targetGray[videos[e]]=JSON.parse(JSON.stringify(t))}Target=null,candidate=[];for(let e=0;e<videos.length;e++)candidate.push(0);tracking.Brief.N=window.descriptorLength,doMatch()};async function doMatch(){if(canDetection){timer++;var e=videoCap.videoWidth,t=videoCap.videoHeight,a=0,a=t<e?.65*t:.65*e;context.drawImage(videoCap,(e-a)/2,(t-a)/2,a,a,0,0,captureSize,captureSize);var a=context.getImageData(0,0,captureSize,captureSize),a=await tracking.Image.grayscale(tracking.Image.blur(a.data,captureSize,captureSize,blurRadius),captureSize,captureSize),i=await tracking.Fast.findCorners(a,captureSize,captureSize),o=await tracking.Brief.getDescriptors(a,captureSize,i);for(let e=0;e<videos.length;e++){var r=await tracking.Fast.findCorners(targetGray[videos[e]],captureSize,captureSize),n=await tracking.Brief.getDescriptors(targetGray[videos[e]],captureSize,r);matches=tracking.Brief.reciprocalMatch(r,n,i,o),matches.sort((e,t)=>t.confidence-e.confidence);for(var c=0,d=0;d<Math.min(matchLength,matches.length);d++){var s=matches[d].keypoint1[0]-matches[d].keypoint2[0],l=matches[d].keypoint1[1]-matches[d].keypoint2[1];c+=s*s+l*l}if(matches.length>matchLength&&c<Threshold&&(candidate[e]++,correctBar.isStop=!1,recogPercent+=50,correctBar.title=Titles[e],loopBar()),2<=candidate[e]){canDetection=!1;for(let e=0;e<videos.length;e++)candidate[e]=0;matchedIndex=e,window.addEventListener("endProgress",VideoSelet),loopBar();break}}!notimer&&100<timer&&(VideoClear(),canDetection=!1,dialogOption2={show:"fade",hide:"fade",dialogClass:"no-close",width:"70%",buttons:[{text:"不再通知",click:function(){canDetection=notimer=!0,$(this).dialog("close")}},{text:"知道了",click:function(){canDetection=!0,$(this).dialog("close")}}]},$("#dialog>p").html("請將繪本上的手語圖對準在畫面中的框框內，若仍無法成功辨識，請按此=> <a href='#'>參考使用說明<//a>"),$("#dialog").dialog(dialogOption2),timer=0)}setTimeout(doMatch,1e3/fps)}